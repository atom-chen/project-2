-----------------------------------------------
--战绩
-----------------------------------------------

local exploits = class("exploits",lib.layer.BaseWindow)
local GameResPath  = "game/niuniu/res/GameLayout/NiuNiu/"

exploits.close = 1 			--------关闭
exploits.show = 2 			--------显示
exploits.hide = 3 			--------隐藏
local SCROLL_SIZEX = 1164

function exploits:ctor()
	exploits.super.ctor(self)
	self.itemArray = {}
end

function exploits:initInter(playerList,exploitArray,playerInfo)
	local exp = cc.CSLoader:createNode(GameResPath.."exploits.csb")
	self:addChild(exp)

	local bg = exp:getChildByName("exploits_bg")
	self:_onRootPanelInit(bg)
	local x,y = bg:getContentSize().width,bg:getContentSize().height

	local titlebg = bg:getChildByName("exp_title")
	local xx,yy = titlebg:getContentSize().width,titlebg:getContentSize().height

	self.seatArray = {}

	for i,v in ipairs(playerList) do
		local str = playerInfo[v.uid].NickName
		local name = cc.Label:createWithSystemFont(string.getMaxLen(str,8),SYSFONT,24)
		name:setPosition(155*i,yy/2+15)
		name:setColor(cc.c3b(255,228,209))
		titlebg:addChild(name)

		local score = cc.Label:createWithSystemFont("总:"..playerInfo[v.uid].playerCoin,SYSFONT,24)
		score:setPosition(155*i,yy/2-15)
		titlebg:addChild(score)
		if playerInfo[v.uid].playerCoin >=0 then
			score:setColor(cc.c3b(255,236,109))
			score:setString("总:+"..playerInfo[v.uid].playerCoin)
		else
			score:setColor(cc.c3b(133,228,255))
		end

		table.insert(self.seatArray,v.seatid)
	end

	local close = bg:getChildByName("exploits_close")
	close:setTag(exploits.close)
	close:addClickEventListener(function(sender) self:onCloseCallback(sender) end)
	if next(self.itemArray) ~= nil then
		for i,v in ipairs(self.itemArray) do
			self.itemArray[i]:hide()
			self.itemArray[i] = nil
		end
	end
	if exploitArray~=nil then
		local contentSize = cc.size(SCROLL_SIZEX,56+(#exploitArray-1)*77)
		local scrollview=ccui.ScrollView:create() 
		scrollview:setTouchEnabled(true) 
		scrollview:setBounceEnabled(true) --–这句必须要不然就不会滚动噢 
	    scrollview:setInertiaScrollEnabled(true)--滑动的惯性
		scrollview:setDirection(ccui.ScrollViewDir.vertical) --–设置滚动的方向 
		scrollview:setContentSize(cc.size(x,y-220)) --–设置尺寸 
		scrollview:setPosition(cc.p(0,455))
		scrollview:setAnchorPoint(cc.p(0,1))
		scrollview:setScrollBarEnabled(false)
		scrollview:setInnerContainerSize(contentSize)
		bg:addChild(scrollview)
		self.scrollview = scrollview

		local ItemNode=cc.Node:create()
	    local tempPos=0
	    local index = nil
	    for i,v in ipairs(exploitArray) do
	    	local Item=self:createItem(i,v)
		    ItemNode:addChild(Item)
		    local yy=Item:getContentSize().height
		    tempPos =-(yy+20)*(i-1)
		    Item:setPosition(0,tempPos)
		    table.insert(self.itemArray,Item)
	    end
	    if #exploitArray < 6 then
	    	ItemNode:setPosition(582,contentSize.height+(6-#exploitArray)*65-#exploitArray*10)
	    else
	    	ItemNode:setPosition(582,contentSize.height-35)
	    end
	    self.ItemNode = ItemNode
	    self.scrollview:addChild(ItemNode)
	end

end

function exploits:cardTxtBg(index)
	local x,y = self.itemArray[index]:getContentSize().width,self.itemArray[index]:getContentSize().height
	local cardBg = cc.Scale9Sprite:createWithSpriteFrameName("exp_zhankai.png")
    cardBg:setAnchorPoint(0.5,1)
    cardBg:setContentSize(cc.size(1102, 168))
    cardBg:setPosition(x/2,y)
    self.itemArray[index]:addChild(cardBg,-1)
    self.cardBg = cardBg
end

function exploits:hidecardTxtBg()
	self.cardBg:hide()
end

function exploits:createItem(index,dataArray)
	local expArray = {}
	for i,v in ipairs(self.seatArray) do
		for a,b in ipairs(dataArray) do
			if v == b.playerSeatId then
				table.insert(expArray,b)
			end
		end
	end

	local playerItem = cc.Sprite:createWithSpriteFrameName("exp_player_bg.png")
	local x,y = playerItem:getContentSize().width,playerItem:getContentSize().height
	playerItem:setTag(index)
	self.playerItem = playerItem

	local curInn = cc.Label:createWithSystemFont(tostring(dataArray.curGameNum),SYSFONT, 24)
	curInn:setPosition(35,y/2)
	playerItem:addChild(curInn)

	local curTimeTxt = cc.Label:createWithSystemFont(expArray[1].time,SYSFONT,24)
	curTimeTxt:setPosition(x-155,y/2)
	playerItem:addChild(curTimeTxt)
	
	local showCancel = ccui.Button:create("exp_btn_down_0.png","exp_btn_down_1.png",ccui.TextureResType.plistType)
	showCancel:setPosition(x-33,y/2)
	playerItem:addChild(showCancel)
	showCancel:hide()
	showCancel:setTag(exploits.show)
	showCancel:addClickEventListener(function(sender) self:onClickBack(sender) end)
	local hideCancle = ccui.Button:create("exp_btn_top_0.png","exp_btn_top_1.png",ccui.TextureResType.plistType)
	hideCancle:setPosition(x-33,y/2)
	playerItem:addChild(hideCancle)
	hideCancle:hide()
	hideCancle:setTag(exploits.hide)
	hideCancle:addClickEventListener(function(sender) self:onClickBack(sender) end)

	for i,v in ipairs(expArray) do
		local score = cc.Label:createWithSystemFont(v.playerGoal,SYSFONT,24)
		score:setPosition(150*i,y/2)
		playerItem:addChild(score)
		if v.playerGoal >= 0 then
			score:setColor(cc.c3b(255,236,109))
			score:setString("+"..v.playerGoal)
		else
			score:setColor(cc.c3b(133,228,255))
		end
	end
	return playerItem
end

function exploits:onClickBack(sender)
	local tag = sender:getTag()
	if tag == exploits.show then
		for i,v in ipairs(self.itemArray) do
			if sender:getParent():getTag() == self.itemArray[i]:getTag() then
				self.itemArray[i]:getChildByTag(exploits.show):hide()
				self.itemArray[i]:getChildByTag(exploits.hide):show()
				-- self:cardTxtBg(i)
				-- local yy = self.itemArray[i]:getContentSize().height
				-- for j=i+1,#self.itemArray do
				-- 	self.itemArray[j]:runAction(cc.MoveTo:create(0.1,cc.p(0,self.itemArray[j]:getPositionY()-115)))
				-- end
			end
		end
		-- self.scrollview:setInnerContainerSize(cc.size(SCROLL_SIZEX,56+(#self.itemArray-1)*77+115))
	elseif tag == exploits.hide then
		for i,v in ipairs(self.itemArray) do
			if sender:getParent():getTag() == self.itemArray[i]:getTag() then
				self.itemArray[i]:getChildByTag(exploits.show):show()
				self.itemArray[i]:getChildByTag(exploits.hide):hide()
			end
		end
	end
end

function exploits:onEnter()
	exploits.super.onEnter(self)
end

return exploits
